{% extends 'base_site.html' %} {% load static %} 
{% block title %}Painel administrativo{% endblock %} 
{% block css %} {{block.super}} {% endblock%}
{% block main_conteudo %}
<div class="col">

    <div class="modal hidden" id='modal' tabindex="-1" role="dialog">
        <div class="message">

        </div>

        <div>
            <button class="btn btn-danger" id='decline'>DECLINE</button>
            <button class="btn btn-primary" id='agree'>AGREE</button>

        </div>
      </div>

  <form id="excluir_candidato">
    <div>
    <label for="cpf">CPF:</label>
    <input
      id="cpf"
      type="text"
      class="form-control mb-2"
      onkeydown="mascara(this, icpf)"
      required
    />
    </div>
    <button class="btn btn-danger">Excluir CPF</button>
    <form />
</div>

      <script>
        function mascara(o, f) {
          v_obj = o;
          v_fun = f;
          setTimeout("execmascara()", 1);
        }
        function execmascara() {
          v_obj.value = v_fun(v_obj.value);
        }
        function icpf(v) {
          v = v.replace(/\D/g, ""); //Remove tudo o que nao e digito
          v = v.replace(/(\d{3})(\d)/, "$1.$2"); //Coloca um ponto entre o terceiro e o quarto digitos
          v = v.replace(/(\d{3})(\d)/, "$1.$2"); //Coloca um ponto entre o terceiro e o quarto digitos
          //de novo (para o segundo bloco de numeros)
          v = v.replace(/(\d{3})(\d{1,2})$/, "$1-$2"); //Coloca um hifen entre o terceiro e o quarto digitos
          return v;
        }

        document
          .getElementById("excluir_candidato")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            cpf = document.getElementById("cpf").value;
            cpf.replace("-", "");
            cpf.replace(".", "");

            const response = await fetch("/excluir_cpf", {
              method: "POST",
              headers: {
                "X-CSRFToken": "{{ csrf_token }}",
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ cpf, step: 0 }),
            });
            const data = await response.json();

            console.log(data);
            const modal = document.querySelector('#modal')
            const agree = document.querySelector('#agree')
            const decline = document.querySelector('#decline')

            modal.classlist.remove('hidden')

            modal.querySelector('.message').innerText = `VocÃª realmente deseja excluir os ${data.qnt_excluidos} registros com o CPF ${document.getElementById("cpf").value}?`

            agree.addEventListener('click', async ()=>{
                const response = await fetch("/excluir_cpf", {
                    method: "POST",
                    headers: {
                      "X-CSRFToken": "{{ csrf_token }}",
                      "Content-Type": "application/json",
                    },
                    body: JSON.stringify(data),
                  });
                  const data = await response.json();
                  console.log(data)
            })

            decline.addEventListener('click', ()=>{
                return
            })
            
          });
      </script>

      <style>
        .hidden{
            display: hidden;
        }
      </style>

{% endblock %}
